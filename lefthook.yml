# yaml-language-server: $schema=https://json.schemastore.org/lefthook.json

pre-commit:
  parallel: true
  commands:
    # Beads: Flush pending changes before commit (bypasses debounce)
    beads-sync:
      run: |
        if command -v bd &> /dev/null && [ -d ".beads" ]; then
          bd --no-daemon export 2>/dev/null || true
        fi
      stage_fixed: true
    
    format:
      glob: "*.{ts,tsx,json,md}"
      run: |
        export PATH="$HOME/.bun/bin:$PATH"
        bun run format
      stage_fixed: true
    
    check:
      glob: "*.{ts,tsx}"
      run: |
        export PATH="$HOME/.bun/bin:$PATH"
        bun run check
      stage_fixed: true
    
    docs-check:
      files: git diff --cached --name-only --diff-filter=ACM "*.md"
      run: |
        export PATH="$HOME/.bun/bin:$PATH"
        bun run docs:check
    
    docs-type-check:
      files: git diff --cached --name-only --diff-filter=ACM "*.ts"
      run: |
        export PATH="$HOME/.bun/bin:$PATH"
        bun run docs:type-check
  
  skip:
    - merge
    - rebase

post-merge:
  commands:
    # Beads: Import updated JSONL after pull/merge
    beads-import:
      run: |
        if command -v bd &> /dev/null && [ -d ".beads" ]; then
          bd --no-daemon import -i .beads/issues.jsonl 2>/dev/null || true
        fi

post-checkout:
  commands:
    # Beads: Import updated JSONL after branch switch
    beads-import:
      run: |
        if command -v bd &> /dev/null && [ -d ".beads" ]; then
          bd --no-daemon import -i .beads/issues.jsonl 2>/dev/null || true
        fi

pre-push:
  commands:
    # Beads: Export database to JSONL before push (critical for multi-workspace sync)
    beads-export:
      run: |
        if command -v bd &> /dev/null && [ -d ".beads" ]; then
          bd --no-daemon export 2>/dev/null || true
        fi
    
    test:
      run: |
        export PATH="$HOME/.bun/bin:$PATH"
        bun run test --run

commit-msg:
  commands:
    conventional:
      run: |
        grep -qE '^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?!?: .{1,88}' "$1" || \
        (echo "‚ùå Commit message must follow Conventional Commits" && exit 1)
