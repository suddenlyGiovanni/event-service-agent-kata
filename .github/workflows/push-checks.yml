name: ğŸš€ Push Checks
on:
  push:
    branches-ignore:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  auto-fix:
    name: ğŸ”§ Auto-fix Code
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ§© Install dependencies
        uses: ./.github/actions/setup

      - name: ğŸ“‹ Detect changed Markdown files
        uses: tj-actions/changed-files@v47
        id: changed-markdown-files
        with:
          files: '**/*.md'
          separator: ","

      - name: ğŸ“ Format Markdown files
        if: steps.changed-markdown-files.outputs.any_changed == 'true'
        shell: sh
        run: bun run format:docs:markdown

      - name: ğŸš¦ Commit Markdown fixes
        shell: bash
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore: format markdown files"
          fi

      - name: ğŸ’… Format code
        shell: sh
        run: bun run format:code

      - name: ğŸš¦ Commit format fixes
        shell: bash
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore: format code"
          fi

      - name: ğŸ“š Format JSDoc comments
        shell: sh
        run: bun run format:docs:jsdoc

      - name: ğŸš¦ Commit JSDoc fixes
        shell: bash
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore: format JSDoc comments"
          fi

      - name: ğŸš¨ Lint code
        shell: sh
        run: |
          bun biome check \
          --max-diagnostics=none \
          --vcs-enabled=true \
          --vcs-use-ignore-file=true \
          --vcs-root="." \
          --formatter-enabled=false \
          --linter-enabled=true \
          --assist-enabled=true \
          --no-errors-on-unmatched \
          --reporter=github \
          --changed \
          --write

      - name: ğŸš¦ Commit lint fixes
        shell: bash
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore: lint code with Biome"
          fi

      - name: ğŸ“¤ Push all fixes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

  validate:
    name: âœ… Validate (${{ matrix.check }})
    runs-on: ubuntu-latest
    needs: auto-fix
    strategy:
      fail-fast: false
      matrix:
        check: [typecheck, test]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ§© Install dependencies
        uses: ./.github/actions/setup

      - name: ğŸ” Run ${{ matrix.check }}
        run: |
          if [ "${{ matrix.check }}" = "typecheck" ]; then
            bun run type-check
          elif [ "${{ matrix.check }}" = "test" ]; then
            bun run test --run
          fi
